name: Build RHEL 9 RPM

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-rpm:
    name: Build RPM for RHEL 9
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9

    steps:
      - name: Install build dependencies
        run: |
          # Retry logic for dnf operations to handle transient network errors
          retry_dnf() {
            local max_attempts=3
            local attempt=1
            local delay=5

            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts: $@"
              if dnf "$@"; then
                return 0
              fi

              if [ $attempt -lt $max_attempts ]; then
                echo "Command failed. Retrying in ${delay}s..."
                sleep $delay
                delay=$((delay * 2))
              fi
              attempt=$((attempt + 1))
            done

            echo "Command failed after $max_attempts attempts"
            return 1
          }

          # Clean dnf cache and update metadata
          dnf clean all
          retry_dnf makecache

          # Install packages with retry logic
          retry_dnf install -y dnf-plugins-core
          retry_dnf config-manager --set-enabled crb
          retry_dnf install -y epel-release
          retry_dnf install -y rpm-build gcc libpcap-devel tar gzip git

      - name: Configure git for container
        run: |
          git config --global --add safe.directory '*'

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          source $HOME/.cargo/env
          rustc --version
          cargo --version
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create RPM build directory structure
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

      - name: Build Rust binary
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo --version
          cargo build --release
          ls -lh target/release/linux-dhcp-forwarder

      - name: Create source tarball with pre-built binary
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          tar czf ~/rpmbuild/SOURCES/linux-dhcp-forwarder-${VERSION}.tar.gz \
            --transform "s,^,linux-dhcp-forwarder-${VERSION}/," \
            --exclude='.git' \
            --exclude='.github' \
            Cargo.toml Cargo.lock src/ config.example.json linux-dhcp-forwarder.service README.md target/release/linux-dhcp-forwarder

      - name: Copy CI spec file
        run: |
          cp linux-dhcp-forwarder-ci.spec ~/rpmbuild/SPECS/linux-dhcp-forwarder.spec

      - name: Build RPM
        run: |
          rpmbuild -ba ~/rpmbuild/SPECS/linux-dhcp-forwarder.spec

      - name: Find built RPM
        id: find_rpm
        run: |
          RPM_PATH=$(find ~/rpmbuild/RPMS -name "*.rpm" -type f | head -1)
          RPM_NAME=$(basename "$RPM_PATH")
          echo "RPM_PATH=$RPM_PATH" >> $GITHUB_OUTPUT
          echo "RPM_NAME=$RPM_NAME" >> $GITHUB_OUTPUT
          echo "Built RPM: $RPM_PATH"

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-dhcp-forwarder-rpm-rhel9
          path: ~/rpmbuild/RPMS/x86_64/*.rpm
          if-no-files-found: error

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ~/rpmbuild/RPMS/x86_64/*.rpm
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
